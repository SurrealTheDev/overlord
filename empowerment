Players = game:GetService("Players")
RStorage = game:GetService("ReplicatedStorage")
Builds = workspace:WaitForChild("Engineer Builds")
local me = Players.LocalPlayer
local mouse = me:GetMouse()

me:SetAttribute("TARGET","None");
me:SetAttribute("TARGETTYPE","PKA");
me:SetAttribute("REPEAT",20);
me:SetAttribute("KARADIUS",30);
me:SetAttribute("GROUP",false);
me:SetAttribute("CANCEL",false);

local vZero = Vector3.new(0, 0, 0)
trgtList = {}


function fire()
    local me = Players.LocalPlayer
    local tSetting = me:GetAttribute("TARGET")
    local rSetting = me:GetAttribute("REPEAT")
    local nSetting = me:GetAttribute("TARGETTYPE")
    local gSetting = me:GetAttribute("GROUP")
    local karSetting = me:GetAttribute("KARADIUS")
    if rSetting<=0 then return end
    local add = {
        target = tSetting,
        repeats = rSetting,
        etype = nSetting,
        group = gSetting,
        radius = karSetting
    }
    if nSetting == "Player"then
        add.args = {
            [1] = nil,
            [2] = vZero,
            [3] = 0,
            [4] = nil
        }
        trgtList[tSetting]=add;
    elseif nSetting == "Engi" then
        add.args =  {
            [1] =  nil,
            [2] =  vZero,
            [3] = 0,
            [4] =  nil
        }
        trgtList[math.random(1,10000)]=add;
    elseif nSetting == "NPC" then
        add.args =  {
            [1] = nil,
            [2] =  vZero,
            [3] = 0,
            [4] =  nil
        }
        trgtList[math.random(10001,20000)]=add;
    elseif nSetting == "PKA" then
        add.args =  {
            [1] = nil,
            [2] =  vZero,
            [3] = 0,
            [4] =  nil
        }
        trgtList[(tSetting.." w ka")]=add;
    end
end

function main()
    for i,v in pairs(trgtList) do
        v.repeats = v.repeats-1
        if v.etype=="Player" then
            if v.group and v.target=="All" then
                for i,v0 in Players:GetPlayers() do
                    local Arg = v.args
                    
                    Arg[1]=workspace:WaitForChild(v0.Name)
                    Arg[4] = Players:WaitForChild(v0.Name).Character:FindFirstChild("Right Arm")
                    pPlayer(Arg)
                end
            else
                local Arg = v.args
                Arg[1]=workspace:WaitForChild(v.target)
                Arg[4] = Players:WaitForChild(v.target).Character:FindFirstChild("Right Arm")
                pPlayer(Arg)
            end
        elseif v.etype=="Engi" then
            if v.group then
               for i0,v0 in workspace:WaitForChild("Engineer Builds"):GetChildren() do
                for i1,v1 in v0:GetChildren() do
                    if (v.target=="All")or(v1.Name==v.target)  then
                        local Arg = v.args
                        Arg[1]=v1
                        Arg[4]=v1:WaitForChild("HumanoidRootPart")
                        RStorage:WaitForChild("Remote Events"):WaitForChild("Punch"):FireServer(unpack(Arg))
                    end
                end
               end
            else
                local Arg = v.args
                local bCh =  workspace:WaitForChild("Engineer Builds"):FindFirstChild("Build Model"):FindFirstChild(v.target)
                Arg[1]=bCh
                Arg[4]=bCh:WaitForChild("HumanoidRootPart")
                RStorage:WaitForChild("Remote Events"):WaitForChild("Punch"):FireServer(unpack(Arg))
            end
        elseif v.etype=="NPC" then
            if v.group then
               for i,v0 in workspace:GetChildren() do
                    if  (v.target=="All" or v0.Name == v.target) and (v0:FindFirstChild("AnimSaves")) then
                        local Arg = v.args
                        Arg[1] = v0
                        Arg[4] = v0:WaitForChild("Torso")
                        RStorage:WaitForChild("Remote Events"):WaitForChild("Punch"):FireServer(unpack(Arg))
                    end
               end
            else
                local Arg = v.args
                local nCh =  workspace:WaitForChild(v.target)
                Arg[1] = nCh
                Arg[4] = nCh:WaitForChild("Torso")
                RStorage:WaitForChild("Remote Events"):WaitForChild("Punch"):FireServer(unpack(Arg))
            end
        elseif v.etype=="PKA" then
            local mBody = workspace:WaitForChild(v.target);
            for i,v0 in Players:GetPlayers() do
                if mBody.Name~=v0.Name then
                    local tBody = workspace:WaitForChild(v0.Name);
                    local pa = mBody.HumanoidRootPart.CFrame.Position
                    local pb = tBody.HumanoidRootPart.CFrame.Position
                    if sqMag(pa,pb)<=(v.radius*v.radius) then
                        local Arg = v.args
                        Arg[1]=tBody
                        Arg[4]=Players:WaitForChild(v0.Name).Character:FindFirstChild("Right Arm")
                        pPlayer(Arg)
                    end
                end
            end
        end
        if v.repeats<=0 then
            trgtList[i]=nil
        end
    end
end
function sqMag(V1,V2)


    
    local nv = V2-V1
    local m =  (nv.X*nv.X)+(nv.Y*nv.Y)+(nv.Z+nv.Z)
    print("Squared distance is " .. m)
    return m
end

function pPlayer(arg)
    if (arg[1]:FindFirstChild("Right Arm").FindFirstChild("SelectionBox")==nil) then
        RStorage:WaitForChild("Remote Events"):WaitForChild("Punch"):FireServer(unpack(arg))
        print("Player has been punched!")
    else
        print("Player has Reverse active!")
    end
end

local connection = mouse.Button2Down:Connect(fire)

repeat
    local exit = me:GetAttribute("CANCEL")
    main()
    wait(0.25)
until exit
connection:Disconnect();
print("Script ended")
